<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulaci√≥n QR - Certificado</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #007bff;
        }
        .qr-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .url-breakdown {
            background: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #28a745;
            margin: 20px 0;
        }
        .expected-behavior {
            background: #fff3cd;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
        }
        .current-problem {
            background: #f8d7da;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
            margin: 20px 0;
        }
        .solution {
            background: #d4edda;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #c3e6cb;
        }
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid #e9ecef;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-success {
            background: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç An√°lisis del QR del Certificado</h1>
            <p>Simulaci√≥n de lo que deber√≠a pasar cuando escaneas el c√≥digo QR</p>
        </div>

        <div class="qr-info">
            <h2>üì± URL del QR Escaneado</h2>
            <div class="code">
                https://tienda.certificalatam.com/web/ultimocertificado/equiposdemedicion/27/42597
            </div>
        </div>

        <div class="url-breakdown">
            <h3>üîó Desglose de la URL</h3>
            <ul>
                <li><strong>Dominio:</strong> tienda.certificalatam.com</li>
                <li><strong>Ruta:</strong> /web/ultimocertificado/</li>
                <li><strong>Tipo de documento:</strong> equiposdemedicion</li>
                <li><strong>ID del equipo:</strong> 27</li>
                <li><strong>ID del usuario/cliente:</strong> 42597</li>
            </ul>
        </div>

        <div class="expected-behavior">
            <h3>‚úÖ Comportamiento Esperado</h3>
            <p>Cuando escaneas el QR, deber√≠a:</p>
            <ol>
                <li>Abrir autom√°ticamente el navegador</li>
                <li>Acceder a la URL del certificado</li>
                <li>El servidor busca el certificado m√°s reciente para:
                    <ul>
                        <li>Tipo: "equiposdemedicion"</li>
                        <li>Equipo ID: 27</li>
                        <li>Cliente ID: 42597</li>
                    </ul>
                </li>
                <li><strong>Descargar autom√°ticamente el PDF del certificado</strong></li>
                <li>Mostrar el certificado en el navegador o en el visor de PDF</li>
            </ol>
        </div>

        <div class="current-problem">
            <h3>‚ùå Problema Actual</h3>
            <p><strong>Error:</strong> "No se pudo cargar el documento PDF"</p>
            <p><strong>Causa:</strong> El servidor remoto <code>tienda.certificalatam.com</code> a√∫n tiene el c√≥digo anterior con el bug del <code>ValueError</code>.</p>
            <p><strong>C√≥digo problem√°tico:</strong></p>
            <div class="code">
                registro_id = int(strmaquinara_id)  # ‚ùå Falla si strmaquinara_id no es num√©rico
                cliente_id = int(userid)            # ‚ùå Falla si userid no es num√©rico
            </div>
        </div>

        <div class="solution">
            <h3>‚úÖ Soluci√≥n Implementada</h3>
            <p>Hemos corregido el c√≥digo para manejar par√°metros inv√°lidos:</p>
            <div class="code">
                # ‚úÖ Conversi√≥n segura
                registro_id = int(strmaquinara_id) if strmaquinara_id and str(strmaquinara_id).isdigit() else False
                cliente_id = int(userid) if userid and str(userid).isdigit() else False
            </div>
            <p><strong>Mejoras implementadas:</strong></p>
            <ul>
                <li>‚úÖ Validaci√≥n de par√°metros obligatorios</li>
                <li>‚úÖ Conversi√≥n segura de IDs</li>
                <li>‚úÖ Logging detallado para diagn√≥stico</li>
                <li>‚úÖ Mensajes de error informativos</li>
                <li>‚úÖ Compatibilidad con versiones anteriores de Python</li>
            </ul>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <h3>üöÄ Pr√≥ximos Pasos</h3>
            <p>Para que el QR funcione correctamente:</p>
            
            <a href="#" class="btn btn-danger" onclick="alert('Necesitas acceso al servidor remoto para hacer esto')">
                1. Desplegar c√≥digo al servidor remoto
            </a>
            
            <a href="#" class="btn btn-success" onclick="alert('Una vez desplegado, el QR descargar√° autom√°ticamente el PDF')">
                2. Probar el QR nuevamente
            </a>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 5px;">
            <h4>üìã Resumen</h4>
            <p><strong>El QR est√° funcionando correctamente</strong> - genera la URL correcta. El problema es que el servidor remoto necesita las correcciones que hemos implementado.</p>
            <p>Una vez desplegadas las correcciones, el QR funcionar√° como se espera: <strong>descarga autom√°tica del certificado PDF</strong>.</p>
        </div>
    </div>

    <script>
        // Simular el comportamiento del QR
        function simulateQRScan() {
            alert('üîç Simulando escaneo de QR...\n\n' +
                  'URL detectada: https://tienda.certificalatam.com/web/ultimocertificado/equiposdemedicion/27/42597\n\n' +
                  '‚è≥ Abriendo navegador...\n' +
                  '‚è≥ Conectando al servidor...\n' +
                  '‚ùå Error: No se pudo cargar el documento PDF\n\n' +
                  'üí° Soluci√≥n: Desplegar las correcciones al servidor remoto');
        }

        // Agregar bot√≥n de simulaci√≥n
        window.onload = function() {
            const container = document.querySelector('.container');
            const simulateBtn = document.createElement('button');
            simulateBtn.textContent = 'üì± Simular Escaneo de QR';
            simulateBtn.className = 'btn';
            simulateBtn.style.display = 'block';
            simulateBtn.style.margin = '20px auto';
            simulateBtn.onclick = simulateQRScan;
            container.appendChild(simulateBtn);
        };
    </script>
</body>
</html>