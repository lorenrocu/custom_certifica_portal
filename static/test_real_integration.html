<!DOCTYPE html>
<html>
<head>
    <title>Prueba de Integraci√≥n Real - QR Overlay</title>
    <meta charset="utf-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 24px; text-align:left; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; }
        .title { font-size: 18px; margin: 0 0 12px 0; }
        .qr-img { width: 147px; height: 147px; border:1px solid #e5e7eb; }
        .pdf-viewer { width: 100%; height: 70vh; border: 1px solid #e5e7eb; border-radius: 8px; }
        .loading { 
            margin: 20px 0; 
            color: #007bff;
            font-weight: bold;
        }
        .error { 
            color: #dc3545; 
            margin: 20px 0; 
            padding: 15px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
        }
        .success { 
            color: #28a745; 
            margin: 20px 0; 
            padding: 15px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
        }
        .config-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: left;
        }
        .config-item {
            margin: 10px 0;
            font-family: monospace;
            background: white;
            padding: 8px;
            border-radius: 3px;
            border-left: 4px solid #007bff;
        }
        .test-buttons {
            margin: 20px 0;
        }
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .test-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Prueba de Integraci√≥n Real - QR Overlay JavaScript</h1>
        <p>Esta p√°gina simula c√≥mo funciona la integraci√≥n real con el backend de Odoo.</p>

        <!-- Vista 2 columnas: QR + Certificado -->
        <div class="grid" style="margin-top:10px;">
            <div class="card">
                <h3 class="title">C√≥digo QR (simulado)</h3>
                <img id="qrPreview" class="qr-img" src="https://api.qrserver.com/v1/create-qr-code/?size=147x147&data=https%3A%2F%2Ftienda.certificalatam.com%2Fweb%2Fultimocertificado%2Fequipos%2F12345%2F67890" alt="QR" />
                <p style="font-size:13px;color:#6b7280;word-break:break-all;">https://tienda.certificalatam.com/web/ultimocertificado/equipos/12345/67890</p>
                <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;">
                    <button class="test-button" onclick="testQROverlay('3.5cm')">Descargar por JavaScript</button>
                    <a class="test-button" style="text-decoration:none;display:inline-block;" href="#" onclick="alert('Simulaci√≥n: en Odoo este enlace usar√≠a /overlay')">Descargar PDF con QR (Servidor)</a>
                </div>
            </div>
            <div class="card">
                <h3 class="title">Certificado (simulado)</h3>
                <object class="pdf-viewer" data="https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf" type="application/pdf">
                    <p>No se pudo incrustar el PDF. <a href="https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf" target="_blank">Descargar</a></p>
                </object>
            </div>
        </div>
        
        <div class="config-section">
            <h3>üìã Configuraci√≥n Simulada (como viene del backend):</h3>
            <div class="config-item"><strong>PDF URL:</strong> https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf</div>
            <div class="config-item"><strong>QR Text:</strong> https://tienda.certificalatam.com/web/ultimocertificado/equipos/12345/67890</div>
            <div class="config-item"><strong>QR Size:</strong> <span id="current-size">3.5cm</span></div>
            <div class="config-item"><strong>Filename:</strong> CERTIFICADO-EQUIPO-12345-QR-OVERLAY-JS.pdf</div>
        </div>
        
        <div class="test-buttons">
            <h3>üéØ Probar Diferentes Tama√±os de QR:</h3>
            <button class="test-button" onclick="testQROverlay('1.5cm')">QR 1.5cm</button>
            <button class="test-button" onclick="testQROverlay('3.5cm')">QR 3.5cm</button>
            <button class="test-button" onclick="testQROverlay('5.0cm')">QR 5.0cm</button>
            <button class="test-button" onclick="testQROverlay('9.5cm')">QR 9.5cm</button>
        </div>
        
        <div id="status" class="loading">Cargando librer√≠as JavaScript...</div>
        <div id="progress"></div>
        
        <div class="config-section">
            <h3>üìä Informaci√≥n T√©cnica:</h3>
            <div id="library-status">Verificando librer√≠as...</div>
            <div id="technical-info"></div>
        </div>
    </div>
    
    <script src="src/js/qr_overlay.js"></script>
    <script>
        let qrManager = null;
        let isReady = false;
        
        // Configuraci√≥n simulada (como viene del backend)
        const baseConfig = {
            pdfUrl: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
            qrText: 'https://tienda.certificalatam.com/web/ultimocertificado/equipos/12345/67890',
            filename: 'CERTIFICADO-EQUIPO-12345-QR-OVERLAY-JS.pdf'
        };
        
        async function initializeSystem() {
            try {
                document.getElementById('status').textContent = 'Inicializando sistema QR Overlay...';
                
                // Esperar a que se cargue qr_overlay.js
                let attempts = 0;
                while (!window.QROverlayManager && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.QROverlayManager) {
                    throw new Error('No se pudo cargar QROverlayManager');
                }
                
                // Crear instancia del manager
                qrManager = new window.QROverlayManager();
                
                document.getElementById('status').textContent = 'Cargando librer√≠as PDF-lib y QRCode...';
                
                // Inicializar librer√≠as
                await qrManager.initialize();
                
                isReady = true;
                
                document.getElementById('status').className = 'success';
                document.getElementById('status').textContent = '‚úÖ Sistema listo para generar QR overlays';
                
                // Actualizar estado de librer√≠as
                updateLibraryStatus();
                
                // Habilitar botones
                const buttons = document.querySelectorAll('.test-button');
                buttons.forEach(btn => btn.disabled = false);
                
            } catch (error) {
                console.error('Error inicializando:', error);
                document.getElementById('status').className = 'error';
                document.getElementById('status').textContent = '‚ùå Error: ' + error.message;
                
                updateLibraryStatus(error);
            }
        }
        
        function updateLibraryStatus(error = null) {
            const statusDiv = document.getElementById('library-status');
            const techDiv = document.getElementById('technical-info');
            
            if (error) {
                statusDiv.innerHTML = '‚ùå <strong>Error cargando librer√≠as:</strong> ' + error.message;
                techDiv.innerHTML = `
                    <p><strong>Nota:</strong> En un entorno real de Odoo, las librer√≠as se cargar√≠an desde CDN o archivos locales.</p>
                    <p><strong>Fallback:</strong> El sistema incluye implementaciones de demostraci√≥n para casos donde las librer√≠as no est√°n disponibles.</p>
                `;
            } else if (qrManager) {
                const pdfLibStatus = qrManager.pdfLib ? '‚úÖ PDF-lib cargado' : '‚ùå PDF-lib no disponible';
                const qrCodeStatus = qrManager.qrCode ? '‚úÖ QRCode.js cargado' : '‚ùå QRCode.js no disponible';
                
                statusDiv.innerHTML = `
                    <div>${pdfLibStatus}</div>
                    <div>${qrCodeStatus}</div>
                `;
                
                techDiv.innerHTML = `
                    <p><strong>Estado:</strong> Sistema completamente funcional</p>
                    <p><strong>Modo:</strong> ${qrManager.pdfLib && qrManager.qrCode ? 'Librer√≠as reales' : 'Modo demostraci√≥n'}</p>
                    <p><strong>Funcionalidades:</strong> Generaci√≥n de QR, overlay en PDF, descarga autom√°tica</p>
                `;
            }
        }
        
        async function testQROverlay(qrSize) {
            if (!isReady || !qrManager) {
                alert('El sistema a√∫n no est√° listo. Por favor espera...');
                return;
            }
            
            try {
                // Actualizar UI
                document.getElementById('current-size').textContent = qrSize;
                document.getElementById('status').className = 'loading';
                document.getElementById('status').textContent = `üîÑ Generando certificado con QR de ${qrSize}...`;
                
                // Deshabilitar botones temporalmente
                const buttons = document.querySelectorAll('.test-button');
                buttons.forEach(btn => btn.disabled = true);
                
                // Configuraci√≥n para esta prueba
                const config = {
                    ...baseConfig,
                    qrSize: qrSize,
                    filename: `CERTIFICADO-EQUIPO-12345-QR-${qrSize}-OVERLAY-JS.pdf`
                };
                
                console.log('Iniciando prueba con configuraci√≥n:', config);
                
                // Generar overlay (simula la llamada real del backend)
                await qrManager.generateQROverlay(
                    config.pdfUrl,
                    config.qrText,
                    config.qrSize,
                    config.filename
                );
                
                document.getElementById('status').className = 'success';
                document.getElementById('status').textContent = `‚úÖ ¬°Certificado con QR de ${qrSize} generado exitosamente!`;
                
            } catch (error) {
                console.error('Error en prueba:', error);
                document.getElementById('status').className = 'error';
                document.getElementById('status').textContent = '‚ùå Error: ' + error.message;
            } finally {
                // Rehabilitar botones
                const buttons = document.querySelectorAll('.test-button');
                buttons.forEach(btn => btn.disabled = false);
            }
        }
        
        // Inicializar cuando se cargue la p√°gina
        window.addEventListener('load', initializeSystem);
    </script>
</body>
</html>